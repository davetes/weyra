generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Player {
  id         Int       @id @default(autoincrement())
  telegramId BigInt    @unique @map("telegram_id")
  phone      String    @default("") @db.VarChar(32)
  username   String    @default("") @db.VarChar(64)
  wallet     Decimal   @default(0) @db.Decimal(12, 2)
  gift       Decimal   @default(0) @db.Decimal(12, 2)
  wins       Int       @default(0)
  bannedAt   DateTime? @map("banned_at")
  banReason  String    @default("") @map("ban_reason") @db.Text
  createdAt  DateTime  @default(now()) @map("created_at")

  selections       Selection[]
  transactions     Transaction[]
  depositRequests  DepositRequest[]
  withdrawRequests WithdrawRequest[]

  @@map("bingo_player")
}

model AdminUser {
  id           Int      @id @default(autoincrement())
  username     String   @unique @db.VarChar(64)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         String   @db.VarChar(32)
  permissions  String   @default("[]") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  sessions AdminSession[]
  auditLogs AdminAuditLog[]

  @@map("admin_user")
}

model AdminSession {
  id        Int       @id @default(autoincrement())
  token     String    @unique @db.VarChar(128)
  adminId   Int       @map("admin_id")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  admin AdminUser @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@map("admin_session")
}

model AdminAuditLog {
  id         Int      @id @default(autoincrement())
  adminId    Int      @map("admin_id")
  action     String   @db.VarChar(64)
  entityType String   @map("entity_type") @db.VarChar(64)
  entityId   String   @map("entity_id") @db.VarChar(64)
  before     String   @default("") @db.Text
  after      String   @default("") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  admin AdminUser @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("admin_audit_log")
}

model AppSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(64)
  value     String   @default("") @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("app_setting")
}

model Game {
  id                 Int       @id
  stake              Int
  active             Boolean   @default(true)
  finished           Boolean   @default(false)
  createdAt          DateTime  @default(now()) @map("created_at")
  countdownStartedAt DateTime? @map("countdown_started_at")
  startedAt          DateTime? @map("started_at")
  sequence           String    @default("") @db.Text
  stakesCharged      Boolean   @default(false) @map("stakes_charged")
  chargedCount       Int       @default(0) @map("charged_count")

  selections Selection[]

  @@map("bingo_game")
}

model Selection {
  id          Int     @id @default(autoincrement())
  gameId      Int     @map("game_id")
  playerId    Int     @map("player_id")
  slot        Int     @default(0)
  index       Int
  accepted    Boolean @default(false)
  autoEnabled Boolean @default(true) @map("auto_enabled")

  game   Game   @relation(fields: [gameId], references: [id])
  player Player @relation(fields: [playerId], references: [id])

  @@unique([gameId, index])
  @@unique([gameId, playerId, slot])
  @@map("bingo_selection")
}

model Transaction {
  id        Int      @id @default(autoincrement())
  playerId  Int      @map("player_id")
  kind      String   @db.VarChar(32)
  amount    Decimal  @db.Decimal(12, 2)
  note      String   @default("") @db.Text
  actorTid  BigInt?  @map("actor_tid")
  createdAt DateTime @default(now()) @map("created_at")

  player Player @relation(fields: [playerId], references: [id])

  @@map("bingo_transaction")
}

model DepositRequest {
  id                Int       @id @default(autoincrement())
  playerId          Int       @map("player_id")
  telegramId        BigInt    @map("telegram_id")
  method            String    @default("") @db.VarChar(32)
  amount            Decimal?  @db.Decimal(12, 2)
  status            String    @default("pending") @db.VarChar(16)
  caption           String    @default("") @db.Text
  adminNote         String    @default("") @map("admin_note") @db.Text
  disputeStatus     String    @default("none") @map("dispute_status") @db.VarChar(16)
  telegramMessageId Int?      @map("telegram_message_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  decidedAt         DateTime? @map("decided_at")
  decidedByAdminId  Int?      @map("decided_by_admin_id")
  decisionNote      String    @default("") @map("decision_note") @db.Text

  player Player @relation(fields: [playerId], references: [id])

  @@index([playerId])
  @@index([status])
  @@map("deposit_request")
}

model WithdrawRequest {
  id               Int       @id @default(autoincrement())
  playerId         Int       @map("player_id")
  telegramId       BigInt    @map("telegram_id")
  amount           Decimal   @db.Decimal(12, 2)
  method           String    @default("") @db.VarChar(32)
  account          String    @default("") @db.Text
  status           String    @default("pending") @db.VarChar(16)
  adminNote        String    @default("") @map("admin_note") @db.Text
  disputeStatus    String    @default("none") @map("dispute_status") @db.VarChar(16)
  createdAt        DateTime  @default(now()) @map("created_at")
  decidedAt        DateTime? @map("decided_at")
  decidedByAdminId Int?      @map("decided_by_admin_id")
  decisionNote     String    @default("") @map("decision_note") @db.Text

  player Player @relation(fields: [playerId], references: [id])

  @@index([playerId])
  @@index([status])
  @@map("withdraw_request")
}
